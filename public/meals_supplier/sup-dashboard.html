<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Supplier Dashboard ‚Äî Samson Connect Meals</title>
<style>
	:root{--orange:#ff6600;--green:#16a34a;--red:#ef4444;--muted:#6b7280}
	body{margin:0;font-family:Segoe UI,Roboto,Arial,sans-serif;background:#f4f6f8;color:#111}
	.app{display:flex;min-height:100vh}
	.sidebar{width:220px;background:#111;color:#fff;padding:20px}
	.sidebar h2{margin:0 0 12px;color:var(--orange)}
	.sidebar a{display:block;color:#fff;text-decoration:none;padding:10px;border-radius:8px;margin-bottom:8px}
	.sidebar a.active{background:var(--orange);color:#000}
	.main{flex:1;padding:28px}
	.header{display:flex;align-items:center;justify-content:space-between;gap:12px}
	h1{margin:0;color:var(--orange);font-size:1.25rem}
	.controls{display:flex;gap:8px;align-items:center}
	.btn{background:#fff;border:1px solid #e6e6e6;padding:8px 12px;border-radius:8px;cursor:pointer}
	.btn.primary{background:var(--orange);border-color:var(--orange);color:#000;font-weight:700}
	.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:18px}
	.card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
	.card h3{margin:0;font-size:0.85rem;color:var(--muted)}
	.card p{margin:8px 0 0 0;font-size:1.35rem;font-weight:700}
	.panel{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-top:18px}
	.section{background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
	.top-controls{display:flex;gap:8px;align-items:center}
	.search input{padding:8px;border-radius:8px;border:1px solid #ddd;width:280px}
	table{width:100%;border-collapse:collapse;margin-top:8px}
	th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:0.95rem}
	th{background:#fafafa;font-weight:700}
	.badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:700;font-size:0.8rem}
	.badge.pending{background:#fff7ed;color:var(--orange);border:1px solid #ffecd1}
	.badge.completed{background:#ecfdf5;color:var(--green);border:1px solid #bbf7d0}
	.badge.cancelled{background:#fff1f2;color:var(--red);border:1px solid #fecaca}
	.top-meals{list-style:none;padding:0;margin:0}
	.top-meals li{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px dashed #f3f3f3}
	.meal-name{flex:1}
	.meal-bar{height:10px;background:#eee;border-radius:6px;overflow:hidden;width:140px;flex-shrink:0}
	.meal-fill{height:100%;background:var(--orange)}
	.small{color:var(--muted);font-size:0.9rem}
	@media (max-width:900px){
		.grid{grid-template-columns:repeat(2,1fr)}
		.panel{grid-template-columns:1fr}
		.search input{width:100%}
	}
</style>
</head>
<body>
<div class="app">
	<div class="sidebar" role="navigation" aria-label="Supplier menu">
		<h2>üë®‚Äçüç≥ Supplier</h2>
		<a href="sup-dashboard.html" class="active">Dashboard</a>
		<a href="sup-orders.html">Incoming Orders</a>
		<a href="sup-meals.html">My Meals</a>
		<a href="sup-stats.html">Analytics</a>
		<a href="sup-profile.html">Profile</a>
	</div>

	<main class="main" id="main">
		<div class="header">
			<div>
				<h1>Supplier Dashboard</h1>
				<div class="small">Overview of orders, revenue and top meals ‚Äî live</div>
			</div>
			<div class="controls">
				<div class="search"><input id="globalSearch" type="search" placeholder="Search customer or meal..."></div>
				<button id="refreshBtn" class="btn">Refresh</button>
				<a href="sup-orders.html" class="btn primary">Manage Orders</a>
			</div>
		</div>

		<div class="top-controls" style="margin-top:12px;gap:10px;align-items:center">
			<button class="btn" onclick="loadAndRender('all')">All</button>
			<button class="btn" onclick="loadAndRender('Pending')">Pending</button>
			<button class="btn" onclick="loadAndRender('Completed')">Completed</button>
			<button class="btn" onclick="loadAndRender('Cancelled')">Cancelled</button>
			<div style="margin-left:auto" class="small" id="lastUpdated">Last update: ‚Äî</div>
		</div>

		<div class="grid" id="cards">
			<div class="card">
				<h3>Total Orders</h3>
				<p id="totalOrders">0</p>
				<div class="small">Combined cart + confirmed</div>
			</div>
			<div class="card">
				<h3>Total Revenue</h3>
				<p id="totalRevenue">TZS 0</p>
				<div class="small">Sum of totals</div>
			</div>
			<div class="card">
				<h3>Pending</h3>
				<p id="pendingOrders">0</p>
				<div class="small">Awaiting action</div>
			</div>
			<div class="card">
				<h3>Completed</h3>
				<p id="completedOrders">0</p>
				<div class="small">Delivered</div>
			</div>
		</div>

		<div class="panel">
			<section class="section">
				<h3 style="margin-top:0">Recent Orders</h3>
				<table aria-label="Recent orders">
					<thead><tr><th>Order</th><th>Customer</th><th>Meal(s)</th><th>Price</th><th>Status</th><th>Map</th></tr></thead>
					<tbody id="recentTbody"><tr><td colspan="6" class="small">Loading‚Ä¶</td></tr></tbody>
				</table>
			</section>

			<aside class="section">
				<h3 style="margin-top:0">Top Meals</h3>
				<ul id="topMeals" class="top-meals"></ul>
				<div style="margin-top:12px" class="small">Top items from recent orders</div>
			</aside>
		</div>
	</main>
</div>

<script>
	// minimal helpers
	const $ = id => document.getElementById(id);
	function escapeHtml(s){ const d=document.createElement('div'); d.textContent = s; return d.innerHTML; }

	let orders = []; let currentStatus = 'all';
	const refreshInterval = 30000; // 30s
	let refreshTimer = null;

	async function loadOrders(status='all') {
		currentStatus = status || 'all';
		const base = '/api/sup/orders';
		const url = (status && status !== 'all') ? `${base}?status=${encodeURIComponent(status)}` : base;
		try {
			const res = await fetch(url);
			if (!res.ok) throw new Error('API error');
			const data = await res.json();
			orders = Array.isArray(data) ? data : [];
			$('lastUpdated').textContent = 'Last update: ' + new Date().toLocaleTimeString();
		} catch (e) {
			console.error('Failed to load orders', e);
			orders = [];
			$('lastUpdated').textContent = 'Last update: (offline)';
		}
	}

	function computeMetrics(list){
		const total = list.length;
		const revenue = list.reduce((s,o)=> s + Number(o.total_price || o.total || 0), 0);
		const pending = list.filter(o => String(o.status||'').toLowerCase().includes('pending')).length;
		const completed = list.filter(o => String(o.status||'').toLowerCase().includes('complete') || String(o.status||'').toLowerCase().includes('deliv')).length;
		return { total, revenue, pending, completed };
	}

	function renderCards(list){
		const m = computeMetrics(list);
		$('totalOrders').textContent = m.total;
		$('totalRevenue').textContent = 'TZS ' + m.revenue.toLocaleString();
		$('pendingOrders').textContent = m.pending;
		$('completedOrders').textContent = m.completed;
	}

	function renderRecent(list){
		const tbody = $('recentTbody');
		const query = (document.getElementById('globalSearch').value || '').toLowerCase();
		const filtered = list.filter(o=>{
			if(!query) return true;
			return (String(o.customer||o.username||'').toLowerCase().includes(query)) ||
			       (String(o.meal||'') .toLowerCase().includes(query)) ||
			       (o.items && JSON.stringify(o.items).toLowerCase().includes(query));
		}).slice(0,50);
		if (filtered.length===0){ tbody.innerHTML = '<tr><td colspan="6" class="small">No orders</td></tr>'; return; }
		tbody.innerHTML = '';
		filtered.forEach(o=>{
			const meals = (o.items && Array.isArray(o.items)) ? o.items.map(it=>escapeHtml(it.name||it.meal||'')).join(', ') : escapeHtml(o.meal||'');
			const price = 'TZS ' + Number(o.total_price||o.total||0).toLocaleString();
			let badgeClass = 'badge pending';
			const st = String(o.status||'').toLowerCase();
			if (st.includes('complete')) badgeClass='badge completed';
			if (st.includes('cancel')) badgeClass='badge cancelled';
			const tr = document.createElement('tr');
			tr.innerHTML = `<td>${o.id}</td>
				<td>${escapeHtml(o.customer||o.username||'N/A')}</td>
				<td>${meals}</td>
				<td>${price}</td>
				<td><span class="${badgeClass}">${escapeHtml(o.status||'Pending')}</span></td>
				<td><button class="btn" onclick="openMap(${o.id})">Map</button></td>`;
			tbody.appendChild(tr);
		});
	}

	function renderTopMeals(list){
		// count items
		const counts = new Map();
		list.forEach(o=>{
			if (o.items && Array.isArray(o.items)) {
				o.items.forEach(it=>{
					const name = (it.name||it.meal||'').trim();
					if (!name) return;
					counts.set(name, (counts.get(name)||0) + (Number(it.qty || it.quantity || 1)));
				});
			} else if (o.meal) {
				const name = String(o.meal||'').trim();
				if (name) counts.set(name, (counts.get(name)||0)+1);
			}
		});
		const arr = Array.from(counts.entries()).sort((a,b)=>b[1]-a[1]).slice(0,8);
		const ul = $('topMeals'); ul.innerHTML = '';
		if (arr.length===0){ ul.innerHTML = '<li class="small">No meals yet</li>'; return; }
		const max = arr[0][1] || 1;
		arr.forEach(([name,count])=>{
			const li = document.createElement('li');
			const pct = Math.round((count/max)*100);
			li.innerHTML = `<div class="meal-name">${escapeHtml(name)}</div>
				<div style="display:flex;align-items:center;gap:8px">
				  <div class="meal-bar"><div class="meal-fill" style="width:${pct}%;"></div></div>
				  <div class="small">${count}</div>
				</div>`;
			ul.appendChild(li);
		});
	}

	// open map in sup-orders page (navigate there, could pass param later)
	function openMap(id){ location.href = `sup-orders.html#order-${id}`; }

	// load, render and schedule refresh
	async function loadAndRender(status='all'){
		await loadOrders(status);
		renderCards(orders);
		renderRecent(orders);
		renderTopMeals(orders);
		// schedule auto refresh
		if (refreshTimer) clearInterval(refreshTimer);
		refreshTimer = setInterval(()=> loadAndRender(currentStatus), refreshInterval);
	}

	// wire controls
	document.getElementById('refreshBtn').addEventListener('click', ()=> loadAndRender(currentStatus));
	document.getElementById('globalSearch').addEventListener('input', ()=> renderRecent(orders));

	// initial
	loadAndRender('all');
</script>
</body>
</html>
