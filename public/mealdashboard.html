<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supplier Dashboard | Order Summary</title>
  <!-- Google Maps API with async loading (fixes loading warning) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCSvZmGKlv9reCpsacvBhxhOrN7eMzOGCA&libraries=places&loading=async"></script>
  <style>
    /* Inline CSS based on learned cart.html/user.html: orange/gold theme, removes Tailwind CDN */
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #fff8f0;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: row;
    }
    #map {
      height: 18rem;
      width: 100%;
      border-radius: 0.5rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      margin-bottom: 1rem;
    }
    aside {
      width: 16rem;
      background: linear-gradient(to bottom, #ff6600, #e65c00);
      color: #fff;
      display: flex;
      flex-direction: column;
    }
    aside > div {
      padding: 1.5rem;
      font-size: 1.5rem;
      font-weight: bold;
      border-bottom: 1px solid #4b5563;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    nav {
      flex: 1;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    nav a {
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      background: #c24800;
      color: #fff;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.3s;
    }
    nav a:hover {
      background: #d4af37;
      color: #000;
      transform: scale(1.05);
    }
    nav a.active {
      background: #d4af37;
      color: #000;
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    header {
      height: 4rem;
      background: #fff;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .orders-section {
      width: 33.333%;
      border-right: 1px solid #ddd;
      background: #fff;
      overflow-y: auto;
    }
    .orders-section > div {
      padding: 1rem;
      border-bottom: 1px solid #ddd;
    }
    .orders-section h2 {
      font-size: 1.125rem;
      font-weight: bold;
    }
    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    ul li {
      padding: 1rem;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
      transition: background 0.3s;
    }
    ul li:hover {
      background: #f9fafb;
    }
    .order-detail-section {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .order-detail-card {
      background: #fff;
      border-radius: 0.5rem;
      padding: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
      margin: 1rem;
    }
    .order-detail-card h2 {
      font-size: 1.25rem;
      font-weight: bold;
      color: #1f2937;
    }
    .order-items > div {
      display: flex;
      justify-content: space-between;
      margin: 0.5rem 0;
    }
    .price-summary {
      border-top: 1px solid #ddd;
      padding-top: 0.5rem;
      font-size: 0.875rem;
      color: #4b5563;
    }
    .price-summary p {
      margin: 0.25rem 0;
    }
    .meta-info {
      font-size: 0.875rem;
      color: #4b5563;
      margin-top: 1rem;
    }
    .meta-info p {
      margin: 0.25rem 0;
    }
    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
    button {
      width: 50%;
      padding: 0.75rem;
      border: none;
      border-radius: 0.5rem;
      font-weight: bold;
      font-size: 1.125rem;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
    }
    .accept-btn {
      background: #ff6600;
    }
    .accept-btn:hover {
      background: #e65c00;
      transform: scale(1.05);
    }
    .reject-btn {
      background: #dc2626;
    }
    .reject-btn:hover {
      background: #b91c1c;
      transform: scale(1.05);
    }
    @media (max-width: 768px) {
      body { flex-direction: column; }
      aside { width: 100%; }
      .orders-section { width: 100%; }
      .order-detail-section { margin-top: 1rem; }
      button { width: 100%; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside>
    <div>üçΩ Supplier</div>
    <nav>
      <a href="#" class="active">üì¶ Order Summary</a>
      <a href="#">ü•ò Meals</a>
      <a href="#">üìä Stats</a>
      <a href="#">‚öô Settings</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main>
    <header>
      <h1>Order Summary</h1>
      <span id="loggedInUser">Logged in as Supplier</span>
    </header>
    <div style="display: flex; flex: 1; overflow: hidden;">
      <!-- Orders List -->
      <section class="orders-section">
        <div>
          <h2>Incoming Orders</h2>
        </div>
        <ul id="ordersList">
          <li style="text-align: center;">Loading orders...</li>
        </ul>
      </section>

      <!-- Order Detail + Map -->
      <section class="order-detail-section">
        <div id="map"></div>
        <div class="order-detail-card">
          <h2 id="orderTitle">Order #...</h2>
          <div id="items" class="order-items"></div>
          <div id="priceSummary" class="price-summary"></div>
          <div id="meta" class="meta-info"></div>
          <div class="action-buttons">
            <button id="acceptBtn" class="accept-btn">Accept Order ‚úÖ</button>
            <button id="rejectBtn" class="reject-btn">Reject Order ‚ùå</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    // Initialize variables
    let SUPPLIER = { lat: -6.7924, lng: 39.2083 }; // Fallback
    let map, directionsService, directionsRenderer, supplierMarker, customerMarker;
    let orders = [];
    const currentUser = localStorage.getItem('username') || 'Supplier';
    document.getElementById('loggedInUser').textContent = `Logged in as ${currentUser}`;

    // Load Google Maps libraries (fixes loading warning)
    async function loadGoogleMaps() {
      try {
        await Promise.all([
          google.maps.importLibrary('maps'),
          google.maps.importLibrary('marker'),
          google.maps.importLibrary('places')
        ]);
        await fetchSupplierLocation();
        initMap();
      } catch (err) {
        console.error('Google Maps load error:', err);
        document.getElementById('map').innerHTML = '<p style="text-align: center; color: red;">Map unavailable</p>';
        fetchOrders(); // Continue without map
      }
    }

    // Fetch supplier location dynamically
    async function fetchSupplierLocation() {
      const token = localStorage.getItem('token');
      if (!token) return;
      try {
        const response = await fetch('/api/supplier/location', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          SUPPLIER = await response.json();
        }
      } catch (err) {
        console.error('Fetch supplier location error:', err);
      }
    }

    // Initialize map (fixes Marker deprecation)
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: SUPPLIER,
        zoom: 13,
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true,
      });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map: map,
        suppressMarkers: true,
        polylineOptions: { strokeColor: '#ff6600', strokeWeight: 6 }
      });
      supplierMarker = new google.maps.marker.AdvancedMarkerElement({
        position: SUPPLIER,
        map: map,
        title: 'Supplier',
        content: new google.maps.marker.PinElement({
          glyph: 'üçΩÔ∏è',
          background: '#ff6600',
          borderColor: '#fff'
        }).element
      });
      fetchOrders();
    }

    

    function populateOrdersList() {
      const ordersList = document.getElementById('ordersList');
      ordersList.innerHTML = '';
      orders.forEach(order => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div style="display: flex; justify-content: space-between;">
            <div>
              <p style="font-weight: bold;">Order #${order.id}</p>
              <p style="font-size: 0.875rem; color: #4b5563;">${order.items.map(i => i.name).join(', ')}</p>
            </div>
            <div style="text-align: right;">
              <p style="font-weight: bold; color: #ff6600;">Tsh ${order.total_price.toLocaleString()}</p>
              <span style="font-size: 0.75rem; background: #fed7d7; color: #c2410c; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">${order.status.toUpperCase()}</span>
            </div>
          </div>
        `;
        li.addEventListener('click', () => showOrder(order));
        ordersList.appendChild(li);
      });
    }

    function showOrder(order) {
      if (customerMarker) customerMarker.map = null;
      const customerPos = { lat: order.delivery_lat || -6.8000, lng: order.delivery_lng || 39.2500 };
      customerMarker = new google.maps.marker.AdvancedMarkerElement({
        position: customerPos,
        map: map,
        title: 'Customer',
        content: new google.maps.marker.PinElement({
          glyph: 'üìç',
          background: '#00ff00',
          borderColor: '#fff'
        }).element
      });
      const bounds = new google.maps.LatLngBounds();
      bounds.extend(SUPPLIER);
      bounds.extend(customerPos);
      map.fitBounds(bounds);
      directionsService.route({
        origin: SUPPLIER,
        destination: customerPos,
        travelMode: google.maps.TravelMode.DRIVING
      }, (result, status) => {
        if (status === 'OK') {
          directionsRenderer.setDirections(result);
          const leg = result.routes[0].legs[0];
          updateOrderInfo(order, leg.distance.text, leg.duration.text);
        } else {
          console.error('Directions request failed:', status);
          updateOrderInfo(order, '--', '--');
        }
      });
    }

    function updateOrderInfo(order, distanceText, etaText) {
      document.getElementById('orderTitle').textContent = `Order #${order.id} Details`;
      const itemsDiv = document.getElementById('items');
      itemsDiv.innerHTML = '';
      order.items.forEach(i => {
        const div = document.createElement('div');
        div.textContent = `${i.name} √ó ${i.qty} - Tsh ${(i.price * i.qty).toLocaleString()}`;
        itemsDiv.appendChild(div);
      });
      document.getElementById('priceSummary').innerHTML = `
        <p>Subtotal: Tsh ${order.subtotal.toLocaleString()}</p>
        <p>Delivery Fee: Tsh ${order.delivery_fee.toLocaleString()}</p>
        <p style="font-weight: bold; color: #1f2937;">Total: Tsh ${order.total_price.toLocaleString()}</p>
      `;
      document.getElementById('meta').innerHTML = `
        <p><strong>Customer:</strong> ${order.customer_name} (${order.customer_phone})</p>
        <p><strong>Address:</strong> ${order.delivery_address}</p>
        <p><strong>Distance:</strong> ${distanceText}</p>
        <p><strong>ETA:</strong> ${etaText}</p>
        <p><strong>Placed:</strong> ${order.time_ordered}</p>
      `;
    }



    });

    document.addEventListener('DOMContentLoaded', loadGoogleMaps);
  </script>
</body>
</html>