<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Orders | Samson Connect Meals</title>
<style>
body {margin:0; font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; background:#f4f4f8; display:flex; min-height:100vh;}
.sidebar {width:250px; background:#1a1a1a; color:white; display:flex; flex-direction:column; padding:20px; box-shadow:3px 0 12px rgba(0,0,0,0.3);}
.sidebar h2 {margin:0 0 30px 0; font-size:22px; color:#ff6600; text-align:center;}
.sidebar a {color:white; text-decoration:none; padding:12px 15px; border-radius:8px; margin-bottom:10px; display:block; transition:0.3s;}
.sidebar a:hover, .sidebar a.active {background:#ff6600; color:black;}
.main {flex:1; padding:30px;}
.main h1 {color:#ff6600; margin-bottom:20px;}
.cards {display:flex; gap:20px; flex-wrap:wrap; margin-bottom:20px;}
.card {flex:1 1 200px; background:white; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.15); text-align:center; transition:transform 0.3s;}
.card:hover {transform:translateY(-5px); box-shadow:0 8px 20px rgba(0,0,0,0.25);}
.card h3 {margin-bottom:10px; color:#ff6600;}
.table-filter {margin-bottom:20px;}
.table-filter button {padding:8px 16px; border:none; border-radius:6px; cursor:pointer; margin-right:10px; background:#ff6600; color:white; transition:0.3s;}
.table-filter button.active, .table-filter button:hover {background:#e65c00;}
table {width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.15);}
table th, table td {padding:12px 15px; border-bottom:1px solid #ddd; text-align:left;}
table th {background:#ff6600; color:white;}
table tr:hover {background:#f9f9f9;}
.btn {padding:6px 12px; border:none; border-radius:6px; cursor:pointer; font-size:14px;}
.btn-view {background:#2196F3; color:white;}
.btn-complete {background:#4caf50; color:white;}
.btn-cancel {background:#f44336; color:white;}
.search-box {margin-bottom:20px;}
.search-box input {width:100%; padding:10px; border-radius:6px; border:1px solid #ccc;}
</style>
<script src="/theme.js"></script>
</head>
<body bgcolor="gold">

<div class="sidebar">
    <h2>Admin Panel</h2>
    <a href="admin.html">Dashboard</a>
    <a href="users.html">User Management</a>
    <a href="orders.html" class="active">Orders</a>
    <a href="meals.html">Meals Menu</a>
    <a href="analytics.html">Analytics</a>
    <a href="settings.html">Settings</a>
	<a href="messages.html">Messages</a>
</div>

<div class="main">
    <h1>Orders</h1>

    <!-- Cards -->
    <div class="cards">
        <div class="card">
            <h3>Total Orders</h3>
            <p id="totalOrders">0</p>
        </div>
        <div class="card">
            <h3>Total Revenue</h3>
            <p id="totalRevenue">TZS 0</p>
        </div>
        <div class="card">
            <h3>Pending Orders</h3>
            <p id="pendingOrders">0</p>
        </div>
        <div class="card">
            <h3>Completed Orders</h3>
            <p id="completedOrders">0</p>
        </div>
    </div>

    <!-- Status Filter -->
    <div class="table-filter">
        <button class="active" onclick="filterStatus('all')">All Orders</button>
        <button onclick="filterStatus('Pending')">Pending</button>
        <button onclick="filterStatus('Completed')">Completed</button>
        <button onclick="filterStatus('Cancelled')">Cancelled</button>
    </div>

    <!-- Search -->
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search orders by customer or meal..." onkeyup="filterOrders()">
    </div>

    <!-- Orders Table -->
    <table id="ordersTable">
        <thead>
            <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Mama Ntilie</th>
                <th>Meal</th>
                <th>Price (TZS)</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Dynamic rows go here -->
        </tbody>
    </table>

</div>

<script>
let ordersData = [];
let currentStatus = 'all';

// Fetch orders from backend
async function fetchOrders() {
    try {
        const res = await fetch('/api/orders'); // Use relative path for consistency
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        
        // Handle both array and paginated response
        ordersData = Array.isArray(data) ? data : (data.orders || data.data || []);
        
        if (!Array.isArray(ordersData)) {
            console.warn('⚠️ Unexpected orders response format:', data);
            ordersData = [];
        }

        // Ensure all orders have required fields
        ordersData = ordersData.map(order => ({
            ...order,
            id: order.id || order.order_id || 'N/A',
            customer: order.customer || order.user_id || 'Unknown',
            meal: order.meal || order.meal_name || 'N/A',
            supplier: order.supplier || order.supplier_name || 'N/A',
            total_price: order.total_price || (order.price * (order.quantity || 1) || 0),
            status: order.status || 'Pending',
            price: order.price || 0,
            quantity: order.quantity || 1
        }));

        renderOrders();
    } catch (err) {
        console.error('❌ Error fetching orders:', err);
        ordersData = [];
        renderOrders();
        alert('Error fetching orders. Please refresh the page.');
    }
}

// Render orders table and update dashboard cards
function renderOrders() {
    const tbody = document.querySelector('#ordersTable tbody');
    tbody.innerHTML = '';

    const searchValue = document.getElementById('searchInput').value.toLowerCase();

    const filteredOrders = ordersData.filter(o =>
        (currentStatus === 'all' || o.status === currentStatus) &&
        (o.customer.toLowerCase().includes(searchValue) || o.meal.toLowerCase().includes(searchValue))
    );

    filteredOrders.forEach(order => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${order.id}</td>
            <td>${order.customer}</td>
            <td>${order.supplier || 'N/A'}</td>
            <td>${order.meal}</td>
            <td>TZS ${order.total_price.toLocaleString()}</td>
            <td>${order.status}</td>
            <td>
                <button class="btn btn-view">View</button>
                ${order.status === 'Pending' ? '<button class="btn btn-complete">Complete</button>' : ''}
                ${order.status === 'Pending' ? '<button class="btn btn-cancel">Cancel</button>' : ''}
            </td>
        `;
        tbody.appendChild(tr);

        // Add status change handlers
        if (order.status === 'Pending') {
            tr.querySelector('.btn-complete')?.addEventListener('click', () => updateStatus(order.id, 'Completed'));
            tr.querySelector('.btn-cancel')?.addEventListener('click', () => updateStatus(order.id, 'Cancelled'));
        }
    });

    // Update dashboard cards
    document.getElementById('totalOrders').textContent = ordersData.length;
    const totalRevenue = ordersData.reduce((sum, o) => sum + parseInt(o.total_price), 0);
    document.getElementById('totalRevenue').textContent = 'TZS ' + totalRevenue.toLocaleString();
    document.getElementById('pendingOrders').textContent = ordersData.filter(o => o.status === 'Pending').length;
    document.getElementById('completedOrders').textContent = ordersData.filter(o => o.status === 'Completed').length;
}

// Update order status
async function updateStatus(id, status) {
    try {
        await fetch(`http://localhost:5000/api/orders/${id}/status`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({status})
        });
        showToast(`Order ${status} ✅`);
        fetchOrders(); // Refresh table
    } catch (err) {
        console.error(err);
        showToast('Failed to update order ❌', true);
    }
}

// Status filter buttons
function filterStatus(status) {
    currentStatus = status;
    document.querySelectorAll('.table-filter button').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.table-filter button[onclick="filterStatus('${status}')"]`).classList.add('active');
    renderOrders();
}

// Live search
function filterOrders() {
    renderOrders();
}

// Toast notification
function showToast(msg, err=false) {
    const t = document.getElementById('toast');
    if (!t) return;
    t.textContent = msg;
    t.style.background = err ? '#f44336' : '#4caf50';
    t.style.display = 'block';
    t.style.transform = 'translateY(0)';
    t.style.opacity = 1;
    setTimeout(() => {
        t.style.transform = 'translateY(20px)';
        t.style.opacity = 0;
        setTimeout(() => t.style.display='none', 300);
    }, 2000);
}

// Initial fetch
fetchOrders();
</script>


</body>
</html>
